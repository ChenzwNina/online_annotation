<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Widget Annotation</title>
    <style>
        /* Clear floats after the columns */
        .container {
            display: flex; /* Use Flexbox for layout */
            gap: 20px; /* Adds 20px space between columns */
            justify-content: center; /* Center the columns horizontally */
        }

        .column:first-child {
            flex: 0 0 70%; /* Left column takes 70% of the container */
            max-width: 70%; /* Prevent it from growing larger than 70% */
        }

        .column:last-child {
            flex: 0 0 30%; /* Right column takes 30% of the container */
            max-width: 30%; /* Prevent it from growing larger than 30% */
        }

        .column img {
            max-width: 100%;
            height: auto; /* Ensure the image scales properly */
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 4px; /* Rounded corners for buttons */
            background-color: #007bff; /* Button background color */
            color: white; /* Button text color */
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3; /* Button hover effect */
        }

        .inline-buttons {
            display: flex;
            justify-content: center;  /* Center the buttons */
            gap: 10px; /* Add spacing between the buttons */
            margin-top: 20px; /* Add some spacing above the buttons */
        }

    </style>
</head>

<body>
    <div class="container">
        <div id="column">
            <div id="video-scenes">
                <!-- Video scenes will be dynamically inserted here -->
            </div>
        </div>
        <div id="column">
            <div class="controls">
                <div>
                    <h2>Dark Pattern Type</h2>
                    <div>
                        <thread> 
                            <h4> Sneaking </h4>
                        <tbody>
                            <label for="sneak-into-basket">
                                <input type="checkbox" name="dark_pattern_type" id="sneak-into-basket" value ="sneak-into-basket">
                                Sneak into Basket
                            </label>
                            <label for="hidden-costs">
                                <input type="checkbox" name="dark_pattern_type" id="hidden-costs" value ="hidden-costs">
                                Hidden Costs
                            </label>
                            <label for="hidden-subscription">
                                <input type="checkbox" name="dark_pattern_type" id="hidden-subscription" value ="hidden-subscription">
                                Hidden Subscription
                            </label>
                        </tbody>
                        <thread> 
                            <h4> Urgency </h4>
                        <tbody>
                            <label for="countdown-timer">
                                <input type="checkbox" name="dark_pattern_type" id="countdown-timer" value ="countdown-timer">
                                Countdown Timer
                            </label>
                            <label for="limited-time-message">
                                <input type="checkbox" name="dark_pattern_type" id="limited-time-message" value ="limited-time-message">
                                Limited-time Message
                            </label>
                        </tbody>
                        <thread> 
                            <h4> Misdirection </h4>
                        <tbody>
                            <label for="confirmshaming">
                                <input type="checkbox" name="dark_pattern_type" id="confirmshaming" value ="confirmshaming">
                                Confirmshaming
                            </label>
                            <label for="visual-interference">
                                <input type="checkbox" name="dark_pattern_type" id="visual-interference" value ="visual-interference">
                                Visual Interference
                            </label>
                            <label for="trick-questions">
                                <input type="checkbox" name="dark_pattern_type" id="trick-questions" value ="trick-questions">
                                Trick Questions
                            </label>
                            <label for="pressured-selling">
                                <input type="checkbox" name="dark_pattern_type" id="pressured-selling" value ="pressured-selling">
                                Pressured Selling
                            </label>
                        </tbody>
                        <thread> 
                            <h4> Social Proof </h4>
                        <tbody>
                            <label for="acitvity-message">
                                <input type="checkbox" name="dark_pattern_type" id="acitvity-message" value ="acitvity-message">
                                Activity Message
                            </label>
                            <label for="testimonials">
                                <input type="checkbox" name="dark_pattern_type" id="testimonials" value ="testimonials">
                                Testimonials
                            </label>
                        </tbody>
                        <thread> 
                            <h4> Scarcity</h4>
                        <tbody>
                            <label for="low-stock-message">
                                <input type="checkbox" name="dark_pattern_type" id="low-stock-message" value ="low-stock-message">
                                Low-stock Message
                            </label>
                            <label for="high-demand-message">
                                <input type="checkbox" name="dark_pattern_type" id="high-demand-message" value ="high-demand-message">
                                High-demand Message
                            </label>
                        </tbody>
                        <thread> 
                            <h4> Obstruction</h4>
                        <tbody>
                            <label for="hard-to-cancel">
                                <input type="checkbox" name="dark_pattern_type" id="hard-to-cancel" value ="hard-to-cancel">
                                Hard to Cancel
                            </label>
                        </tbody>
                        <thread> 
                            <h4> Forced Action</h4>
                        <tbody>
                            <label for="forced-enrollment">
                                <input type="checkbox" name="dark_pattern_type" id="forced-enrollment" value ="forced-enrollment">
                                Forced Enrollment
                            </label>
                        </tbody>
                        <thread> 
                            <h4> Other</h4>
                        <tbody>
                            <label for="not-dark-pattern">
                                <input type="radio" name="dark_pattern_type" id="not-dark-pattern" value ="not-dark-pattern">
                                Not a Dark Pattern
                            </label>
                            <label for="not-sure">
                                <input type="radio" name="dark_pattern_type" id="not-sure" value ="not-sure">
                                Not Sure
                            </label>
                        </tbody>
                    </div>
        
                <div>
                    <h2>Dark Pattern Severity</h2>
                    <p> If a dark pattern exists, select its severity. If there is no dark pattern, skip it. </p>
                    <div>
                        <label for="severe_3">
                            <input type="radio" name="severity" id="severe_3" value="severe_3">
                            Very severe (3)
                        </label>
                    </div>
                    <div>
                        <label for="severe_2">
                            <input type="radio" name="severity" id="severe_2" value="severe_2">
                            A little severe (2)
                        </label>
                    </div>
                    <div>
                        <label for="severe_1s">
                            <input type="radio" name="severity" id="severe_1" value="severe_1">
                            Not severe (1)
                        </label>
                    </div>
            </div>
        <div class = "inline-buttons">
            <button id="prev-button">Previous</button>
            <button id="next-button">Next</button>
        </div>
        </div>
    </div>


    <script>
        // Select all checkboxes and radio buttons
        const allTypeCheckboxes = document.querySelectorAll('input[name="dark_pattern_type"][type="checkbox"]');
        const allTypeRadios = document.querySelectorAll('input[name="dark_pattern_type"][type="radio"]');

        // Function to uncheck radio buttons when a checkbox is selected
        function uncheckRadios() {
            allTypeRadios.forEach((radio) => {
                radio.checked = false; // Uncheck all radio buttons
            });
        }

        // Function to uncheck checkboxes when a radio button is selected
        function uncheckcheckBox() {
            allTypeCheckboxes.forEach((checkbox) => {
            checkbox.checked = false; // Uncheck all checkboxes
        });
        }

        // Add event listeners to all checkboxes
        allTypeCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", uncheckRadios);
        });

        // Add event listeners to all radio buttons
        allTypeRadios.forEach((radio) => {
        radio.addEventListener("change", uncheckcheckBox);
        });


        async function fetchVideoData() {
            const response = await fetch('widget_data.json');
                
            if (response) {
                console.log("Data JSON fetch succeeded")
                return await response.json();}
        }

        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            console.log(urlParams.get(name));
            return urlParams.get(name);
        }

        let videoSource = {};

        async function createVideoScene(videoPair) {
            const scene = document.createElement('div');

            scene.innerHTML = `
            <div>
                <h2><Widget Image</h2>
                <img alt="design_screenshot sizes="print 73px,117px" src="${videoPair.screenshot_location}">
            </div>
            `;

            const response = await fetch('https://rate.chenziwei0499.workers.dev/get', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    key: getQueryParameter('videoIndex')
                })
            });

            const data_text = await response.text();
            if (!data_text || data_text.trim() === "") {
                console.log("Empty response body.");
                return scene;
            }

            const data = JSON.parse(data_text);
            console.log("Raw Response Body:", data);

            const severity_level = data.severity; // Severity is a string

            if (!severity_level) { // Check if type is null, undefined, or falsy
                    console.warn("severity is undefined or null.");
            } else {
                console.log("Checked answer for severity is", severity_level);
                const severityRadio = document.querySelector(`input[name="severity"][value="${severity_level}"]`); //Get severity data
                severityRadio.checked = true; // Set the radio button as checked
            }

            const type = data.dark_pattern_type; // Type is an array or a single string

            if (!type) { // Check if type is null, undefined, or falsy
                    console.warn("dark_pattern_type is undefined or null.");
            } else {
                if (type === 'not-dark-pattern') {
                    // Check not dark pattern radio boxs
                    document.querySelector('#not-dark-pattern').checked = true;

                    // Uncheck all checkboxes
                    document.querySelectorAll('input[type="checkbox"][name="dark_pattern_type"]').forEach((checkbox) => {
                        checkbox.checked = false;
                    });
                }else if (type === 'not-sure-sure') {
                    // Check not dark pattern radio box
                    document.querySelector('#not-sure').checked = true;

                    // Uncheck all checkboxes
                    document.querySelectorAll('input[type="checkbox"][name="dark_pattern_type"]').forEach((checkbox) => {
                        checkbox.checked = false;
                    });
                } else {
                        console.log("Checked answers for dark pattern types are", type);

                        if (typeof type === "string") {
                            type = [type]; // Convert string to an array
                        }

                        if (Array.isArray(type)) { // Ensure type is an array before using forEach
                            type.forEach((dark_type) => {
                                const checkbox = document.querySelector(`input[name="dark_pattern_type"][value="${dark_type}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                } else {
                                    console.warn(`Checkbox for value "${dark_type}" not found.`);
                                }
                            });
                        } else {
                            console.error("Unexpected type format:", type);
                        }
                    }
                }
                return scene;
            }


        async function showScene() {
            const videoData = await fetchVideoData();
            console.log("Video Data :" + JSON.stringify(videoData));
            const videoIndex = getQueryParameter('videoIndex');
            const videoScenes = document.getElementById('video-scenes');
            videoScenes.innerHTML = '<p> Current widget index: ' + videoIndex;

            if (videoIndex !== null && videoIndex < videoData.length && videoIndex >= 0) {
                console.log("Video Data[index]: "+ JSON.stringify(videoData[videoIndex]));
                const scene = await createVideoScene(videoData[videoIndex]);
                videoSource = videoData[videoIndex];
                videoScenes.appendChild(scene);
            } else {
                videoScenes.innerHTML = `
                    <p><strong>Invalid image index</strong></p>
                    <p> Current video index is ${videoIndex}. Total index is ${videoData.length}.</p>
                `;
            }


        }

        // Initialize by showing the scene based on the URL parameter
        showScene();

        function collectData() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoIndex = urlParams.get('videoIndex');

            const dark_pattern_type = document.querySelectorAll('input[name="dark_pattern_type"]:checked');
            const severity = document.querySelector('input[name="severity"]:checked');

            const data = {
                dark_pattern_type: dark_pattern_type.length > 0 
                ? Array.from(dark_pattern_type).map(checkbox => checkbox.value) 
                : null,
                severity: severity ? severity.value : null,
            };

            return data;
        }

        async function uploadData() {
            const data = collectData();
            Toast('Uploading data...', 1000);
            let myuuid = crypto.randomUUID();
            const response = await fetch('https://rate.chenziwei0499.workers.dev/upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    key: myuuid,
                    index: getQueryParameter('videoIndex'),
                    rater: getQueryParameter('user')
                })
            });
            Toast(JSON.stringify(await response.json()), 1000);
            console.log(JSON.stringify({
                    key: getQueryParameter('videoIndex'),
                    value: data
                }));
            const response1 = await fetch('https://rate.chenziwei0499.workers.dev/put', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    key: getQueryParameter('videoIndex'),
                    rater: getQueryParameter('user'),
                    value: data
                })
            });
            await Toast(JSON.stringify(await response1.json()), 1000);
        }

        async function goToNextScene() {
            const videoIndex = parseInt(getQueryParameter('videoIndex'), 10);
            await uploadData();
            const nextIndex = isNaN(videoIndex) ? 0 : videoIndex + 1;
            console.log("Next Scene Index is :"+ nextIndex)
            window.location.search = `?videoIndex=${nextIndex}&user=${getQueryParameter('user')}`;

        }

        async function goToPrevScene() {
            const videoIndex = parseInt(getQueryParameter('videoIndex'), 10);
            await uploadData();
            const nextIndex = isNaN(videoIndex) ? 0 : videoIndex - 1;
            window.location.search = `?videoIndex=${nextIndex}&user=${getQueryParameter('user')}`;
        }

        async function Toast(msg, duration) {
            duration = isNaN(duration) ? 3000 : duration;
            var m = document.createElement('div');
            m.textContent = msg;
            m.style.cssText = "max-width:60%;min-width: 150px;padding:0 14px;height: 40px;color: rgb(255, 255, 255);line-height: 40px;text-align: center;border-radius: 4px;position: fixed;top: 50%;left: 50%;transform: translate(-50%, -50%);z-index: 999999;background: rgba(0, 0, 0,.7);font-size: 16px;";
            document.body.appendChild(m);
            setTimeout(function () {
                var d = 0.5;
                m.style.webkitTransition = '-webkit-transform ' + d + 's ease-in, opacity ' + d + 's ease-in';
                m.style.opacity = '0';
                setTimeout(function () { document.body.removeChild(m) }, d * 1000);
            }, duration);
            // wait for the toast to disappear
            await new Promise(r => setTimeout(r, duration));
        }


        document.getElementById('next-button').addEventListener('click', goToNextScene);
        document.getElementById('prev-button').addEventListener('click', goToPrevScene);
    </script>
</body>

</html>