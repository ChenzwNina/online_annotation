<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Widget Annotation</title>
    <style>
        .video-container {
            display: flex;
            justify-content: space-around;
            align-items: start;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div id="video-scenes">
        <!-- Video scenes will be dynamically inserted here -->
    </div>
    <div class="controls">
        <button id="prev-button">Previous</button>
        <div>
            <label>Dark Pattern Type</label>
            <div>
                <thread> 
                    <p> Sneaking </p>
                <tbody>
                    <label for="sneak-into-basket">
                        <input type="checkbox" name="dark_pattern_type" id="sneak-into-basket" value ="sneak-into-basket">
                        Sneak into Basket
                    </label>
                    <label for="hidden-costs">
                        <input type="checkbox" name="dark_pattern_type" id="hidden-costs" value ="hidden-costs">
                        Hidden Costs
                    </label>
                    <label for="hidden-subscription">
                        <input type="checkbox" name="dark_pattern_type" id="hidden-subscription" value ="hidden-subscription">
                        Hidden Subscription
                    </label>
                </tbody>
                <thread> 
                    <p> Urgency </p>
                <tbody>
                    <label for="countdown-timer">
                        <input type="checkbox" name="dark_pattern_type" id="countdown-timer" value ="countdown-timer">
                        Countdown Timer
                    </label>
                    <label for="limited-time-message">
                        <input type="checkbox" name="dark_pattern_type" id="limited-time-message" value ="limited-time-message">
                        Limited-time Message
                    </label>
                </tbody>
                <thread> 
                    <p> Misdirection </p>
                <tbody>
                    <label for="confirmshaming">
                        <input type="checkbox" name="dark_pattern_type" id="confirmshaming" value ="confirmshaming">
                        Confirmshaming
                    </label>
                    <label for="visual-interference">
                        <input type="checkbox" name="dark_pattern_type" id="visual-interference" value ="visual-interference">
                        Visual Interference
                    </label>
                    <label for="trick-questions">
                        <input type="checkbox" name="dark_pattern_type" id="trick-questions" value ="trick-questions">
                        Trick Questions
                    </label>
                    <label for="pressured-selling">
                        <input type="checkbox" name="dark_pattern_type" id="pressured-selling" value ="pressured-selling">
                        Pressured Selling
                    </label>
                </tbody>
                <thread> 
                    <p> Social Proof </p>
                <tbody>
                    <label for="acitvity-message">
                        <input type="checkbox" name="dark_pattern_type" id="acitvity-message" value ="acitvity-message">
                        Activity Message
                    </label>
                    <label for="testimonials">
                        <input type="checkbox" name="dark_pattern_type" id="testimonials" value ="testimonials">
                        Testimonials
                    </label>
                </tbody>
                <thread> 
                    <p> Scarcity</p>
                <tbody>
                    <label for="low-stock-message">
                        <input type="checkbox" name="dark_pattern_type" id="low-stock-message" value ="low-stock-message">
                        Low-stock Message
                    </label>
                    <label for="high-demand-message">
                        <input type="checkbox" name="dark_pattern_type" id="high-demand-message" value ="high-demand-message">
                        High-demand Message
                    </label>
                </tbody>
                <thread> 
                    <p> Obstruction</p>
                <tbody>
                    <label for="hard-to-cancel">
                        <input type="checkbox" name="dark_pattern_type" id="low-stock-message" value ="low-stock-message">
                        Hard to Cancel
                    </label>
                </tbody>
                <thread> 
                    <p> Forced Action</p>
                <tbody>
                    <label for="forced-enrollment">
                        <input type="checkbox" name="dark_pattern_type" id="forced-enrollment" value ="forced-enrollment">
                        Forced Enrollment
                    </label>
                </tbody>
                <thread> 
                    <p> Other</p>
                <tbody>
                    <label for="not-dark-pattern">
                        <input type="radio" name="dark_pattern_type" id="not-dark-pattern" value ="not-dark-pattern">
                        Not a Dark Pattern
                    </label>
                    <label for="not-sure">
                        <input type="radio" name="dark_pattern_type" id="not-sure" value ="not-sure">
                        Not Sure
                    </label>
                </tbody>
            </div>
 
        <div>
            <label>Dark Pattern Severity</label>
            <div>
                <label for="severe_3">
                    <input type="radio" name="severity" id="severe_3" value="severe_3">
                    Very severe (3)
                </label>
            </div>
            <div>
                <label for="severe_2">
                    <input type="radio" name="severity" id="severe_2" value="severe_2">
                    A little severe (2)
                </label>
            </div>
            <div>
                <label for="severe_1s">
                    <input type="radio" name="severity" id="severe_1" value="severe_1">
                    Not severe (1)
                </label>
            </div>
        <button id="next-button">Next</button>
    </div>

    <script>
        // Select all checkboxes and radio buttons
        const allTypeCheckboxes = document.querySelectorAll('input[name="dark_pattern_type"][type="checkbox"]');
        const allTypeRadios = document.querySelectorAll('input[name="dark_pattern_type"][type="radio"]');

        // Function to uncheck radio buttons when a checkbox is selected
        function uncheckRadios() {
            allTypeRadios.forEach((radio) => {
                radio.checked = false; // Uncheck all radio buttons
            });
        }

        // Function to uncheck checkboxes when a radio button is selected
        function uncheckcheckBox() {
            allTypeCheckboxes.forEach((checkbox) => {
            checkbox.checked = false; // Uncheck all checkboxes
        });
        }

        // Add event listeners to all checkboxes
        allTypeCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", uncheckRadios);
        });

        // Add event listeners to all radio buttons
        allTypeRadios.forEach((radio) => {
        radio.addEventListener("change", uncheckcheckBox);
        });


        async function fetchVideoData() {
            const response = await fetch('/Users/ninachen/Documents/GitHub/dark-pattern-audit/Widget_Generate/widget_data.json');
            return await response.json();
        }

        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        let videoSource = {};

        async function createVideoScene(videoPair) {
            const scene = document.createElement('div');

            const response = await fetch('https://rate.chenziwei0499.workers.dev/get', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    key: getQueryParameter('videoIndex')
                })
            });

            const data = JSON.parse(await response.json()); //Parse the data json object

            const severity_level = data.severity; // Severity is a string

            if (!severity_level) {
            return; // No severity value stored, do nothing
            } else {
                const severityRadio = document.querySelector(`input[name="severity"][value="${severity_level}"]`); //Get severity data
                severityRadio.checked = true; // Set the radio button as checked
            }

            const type = data.dark_pattern_type; // Type is an array or a single string

            if (!type) {
            return; // No dark pattern type value stored, do nothing
            }

            if (type === 'not-dark-pattern') {
                // Check not dark pattern radio box
                document.querySelector('#not-dark-pattern').checked = true;

                // Uncheck all checkboxes
                document.querySelectorAll('input[type="checkbox"][name="dark_pattern_type"]').forEach((checkbox) => {
                    checkbox.checked = false;
                });
            }else if (type === 'not-sure-sure') {
                // Check not dark pattern radio box
                document.querySelector('#not-sure').checked = true;

                // Uncheck all checkboxes
                document.querySelectorAll('input[type="checkbox"][name="dark_pattern_type"]').forEach((checkbox) => {
                    checkbox.checked = false;
                });
            } else {
                // Check value saved in the data
                darkTypes.forEach((dark_type) => {
                    document.querySelector(`input[name="dark_pattern_type"][value="${dark_type}"]`).checked = true;
                })
                }
            
            scene.className = 'video-container';
            scene.innerHTML = `
            <div>
                <p><strong>Widget</strong></p>
                <img alt="design_screenshot sizes="print 73px,117px" src="${videoPair.screenshot_location}" id="screenshot_image">
            </div>
            `;
            return scene;
        }

        async function showScene() {
            const videoData = await fetchVideoData();
            const videoIndex = getQueryParameter('videoIndex');
            const videoScenes = document.getElementById('video-scenes');
            videoScenes.innerHTML = '';

            if (videoIndex !== null && videoIndex < videoData.length && videoIndex >= 0) {
                const scene = await createVideoScene(videoData[videoIndex]);
                videoSource = videoData[videoIndex];
                videoScenes.appendChild(scene);
            } else {
                videoScenes.innerHTML = '<p>Invalid screenshot index.</p>';
            }


        }

        // Initialize by showing the scene based on the URL parameter
        showScene();

        function collectData() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoIndex = urlParams.get('videoIndex');

            const position = document.querySelector('input[name="dark_pattern_type"]:checked');
            const comparison = document.querySelector('input[name="severity"]:checked');

            const data = {
                image: videoSource.screenshot_location,
                dark_pattern_type: dark_pattern_type ? dark_pattern_type.value : null,
                severity: severity ? severity.value : null,
            };

            return data;
        }

        async function uploadData() {
            const data = collectData();
            Toast('Uploading data...', 1000);
            let myuuid = crypto.randomUUID();
            const response = await fetch('https://rate.chenziwei0499.workers.dev/upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    key: myuuid,
                    index: getQueryParameter('videoIndex'),
                    rater: getQueryParameter('user')
                })
            });
            Toast(JSON.stringify(await response.json()), 1000);
            console.log(JSON.stringify({
                    key: getQueryParameter('videoIndex'),
                    value: data
                }));
            const response1 = await fetch('https://rate.chenziwei0499.workers.dev/put', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    key: getQueryParameter('videoIndex'),
                    rater: getQueryParameter('user'),
                    value: data
                })
            });
            await Toast(JSON.stringify(await response1.json()), 1000);
        }

        async function goToNextScene() {
            const videoIndex = parseInt(getQueryParameter('videoIndex'), 10);
            await uploadData();
            const nextIndex = isNaN(videoIndex) ? 0 : videoIndex + 1;
            window.location.search = `?videoIndex=${nextIndex}&user=${getQueryParameter('user')}`;
        }

        async function goToPrevScene() {
            const videoIndex = parseInt(getQueryParameter('videoIndex'), 10);
            await uploadData();
            const nextIndex = isNaN(videoIndex) ? 0 : videoIndex - 1;
            window.location.search = `?videoIndex=${nextIndex}&user=${getQueryParameter('user')}`;
        }

        async function Toast(msg, duration) {
            duration = isNaN(duration) ? 3000 : duration;
            var m = document.createElement('div');
            m.textContent = msg;
            m.style.cssText = "max-width:60%;min-width: 150px;padding:0 14px;height: 40px;color: rgb(255, 255, 255);line-height: 40px;text-align: center;border-radius: 4px;position: fixed;top: 50%;left: 50%;transform: translate(-50%, -50%);z-index: 999999;background: rgba(0, 0, 0,.7);font-size: 16px;";
            document.body.appendChild(m);
            setTimeout(function () {
                var d = 0.5;
                m.style.webkitTransition = '-webkit-transform ' + d + 's ease-in, opacity ' + d + 's ease-in';
                m.style.opacity = '0';
                setTimeout(function () { document.body.removeChild(m) }, d * 1000);
            }, duration);
            // wait for the toast to disappear
            await new Promise(r => setTimeout(r, duration));
        }


        document.getElementById('next-button').addEventListener('click', goToNextScene);
        document.getElementById('prev-button').addEventListener('click', goToPrevScene);
    </script>
</body>

</html>